<!-- templates/index.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taça das Sociedades</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 to-white text-slate-800">
  <!-- Top Bar -->
  <header class="sticky top-0 z-20 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">

      <!-- Esquerda: logo Taça + título -->
      <div class="flex items-center gap-4">
        <img src="{{ url_for('static', filename='taca.png') }}"
             alt="Taça das Sociedades"
             class="h-12 w-12 object-contain" />
        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-sky-800">
          Taça das Sociedades
        </h1>
      </div>
      <!-- Direita: logo CONDEB -->
      <div>
        <img src="{{ url_for('static', filename='condeb.png') }}"
             alt="CONDEB"
             class="h-12 object-contain" />
      </div>
    </div>
  </header>

  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Sidebar -->
    <aside class="lg:col-span-3">
      <nav class="sticky top-20 space-y-2">
        <a class="flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium bg-sky-100 text-sky-900 border border-sky-200" href="/">Início</a>

        {% if session.get('auth_kind') == 'staff' and session.get('role') in ['director','admin'] %}
          <a class="flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:text-sky-900 hover:bg-slate-100 border border-transparent" href="/results">Inserir resultados</a>
        {% endif %}

        <a href="/pairings" class="block rounded-lg px-3 py-2 hover:bg-sky-50 text-slate-700">
          Próximos pareamentos
        </a>
        <a href="/resultados" class="block rounded-lg px-3 py-2 hover:bg-sky-50 text-slate-700">
          Resultados
        </a>

        {% if session.get('auth_kind') == 'society' %}
          <a href="{{ url_for('page_escalacao') }}" class="block rounded-lg px-3 py-2 hover:bg-sky-50 text-slate-700">
            Escalação
          </a>
        {% endif %}
        {% if session.get('auth_kind') == 'staff' and session.get('role') in ['director','admin'] %}
          <a href="{{ url_for('admin_panel') }}"
             class="flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:text-sky-900 hover:bg-slate-100 border border-transparent">
            Painel de administração
          </a>
        {% endif %}
        {% if session.get('auth_kind') in ['staff','society'] %}
          <form method="post" action="/logout">
            <button class="flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:text-sky-900 hover:bg-slate-100 border border-transparent">Sair</button>
          </form>
        {% else %}
          <a class="flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:text-sky-900 hover:bg-slate-100 border border-transparent" href="/login">Login</a>
        {% endif %}
      </nav>
    </aside>

    <!-- Main -->
    <main class="lg:col-span-9 space-y-6">
      <div id="alert" class="hidden rounded-xl border border-amber-300 bg-amber-50 text-amber-900 px-4 py-3"></div>

      <!-- Classificação -->
      <section class="bg-white rounded-2xl shadow-sm border border-slate-200">
        <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
          <h2 class="text-xl font-semibold text-sky-900">Classificação</h2>
          <span id="loading-standings" class="text-sm text-slate-500">carregando…</span>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-sky-50 text-sky-900">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">#</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Sociedade</th>
                <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide">Pontos</th>
                <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide">Speaker Points</th>
                <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide">Total de 1ºs</th>
                <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide">Total de 2ºs</th>
                <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide">Nº de Debates</th>
                <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide">Aproveitamento</th>
              </tr>
            </thead>
            <tbody id="standings-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Próximos Pareamentos -->
      <section class="bg-white rounded-2xl shadow-sm border border-slate-200">
        <div class="px-5 py-4 border-b border-slate-100">
          <div class="flex items-end justify-between gap-3">
            <h2 class="text-xl font-semibold text-sky-900">Próximos pareamentos</h2>
            <div id="nextRound" class="text-sm text-slate-600"></div>
          </div>
        </div>
        <div id="pairings" class="grid md:grid-cols-2 gap-4 p-5"></div>
      </section>
    </main>
  </div>

  <footer class="mt-6 border-t border-slate-200 py-6 text-center text-sm text-slate-500">
    © <span id="year"></span> Taça das Sociedades
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const alertEl = document.getElementById('alert');
    const standingsBody = document.getElementById('standings-body');
    const loadingStandings = document.getElementById('loading-standings');
    const pairingsGrid = document.getElementById('pairings');
    const nextRoundEl = document.getElementById('nextRound');

    function showAlert(msg) {
      alertEl.textContent = msg;
      alertEl.classList.remove('hidden');
    }

    function percAproveitamento(points, debates) {
      if (!debates) return 0;
      return Math.round((points / (3 * debates)) * 100);
    }

    async function loadStandings() {
      try {
        const res = await fetch('/api/standings?edition=current');
        const json = await res.json();
        const data = json.data || [];

        // Garantimos a ordenação (pontos, speaker points, 1ºs, 2ºs, nome)
        data.sort((a, b) => {
          if (b.points !== a.points) return b.points - a.points;
          if (b.speaker_points !== a.speaker_points) return b.speaker_points - a.speaker_points;
          if (b.firsts !== a.firsts) return b.firsts - a.firsts;
          if (b.seconds !== a.seconds) return b.seconds - a.seconds;
          return (a.short_name || '').localeCompare(b.short_name || '');
        });

        standingsBody.innerHTML = '';
        data.forEach((s, idx) => {
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-slate-50/40' : 'bg-white';
          tr.innerHTML = `
            <td class="px-4 py-3 font-medium text-slate-700">${idx + 1}</td>
            <td class="px-4 py-3">
              <a href="/sociedade/${s.edsoc_id}" class="text-sky-700 hover:underline">
                ${s.short_name || ''}
              </a>
            </td>
            <td class="px-4 py-3 text-center font-semibold text-slate-800">${s.points ?? 0}</td>
            <td class="px-4 py-3 text-center">${s.speaker_points ?? 0}</td>
            <td class="px-4 py-3 text-center">${s.firsts ?? 0}</td>
            <td class="px-4 py-3 text-center">${s.seconds ?? 0}</td>
            <td class="px-4 py-3 text-center">${s.debates ?? 0}</td>
            <td class="px-4 py-3 text-center">${percAproveitamento(s.points ?? 0, s.debates ?? 0)}%</td>
          `;
          standingsBody.appendChild(tr);
        });
      } catch (e) {
        showAlert('Exibindo página, mas não foi possível carregar a classificação.');
      } finally {
        loadingStandings.classList.add('hidden');
      }
    }

    async function loadPairings() {
      try {
        const res = await fetch('/api/next_pairings?edition=current');
        const json = await res.json();
        const data = json.data || [];
        pairingsGrid.innerHTML = '';

        if (data.length === 0) {
          pairingsGrid.innerHTML = '<div class="col-span-full text-center text-slate-500 py-8">Sem pareamentos futuros.</div>';
          nextRoundEl.textContent = '';
          return;
        }

        const round = data[0].round_number;
        nextRoundEl.innerHTML = `Próxima rodada: <span class="font-semibold text-slate-800">${round}</span>`;

        for (const p of data) {
          const card = document.createElement('div');
          card.className = 'rounded-xl border border-slate-200 bg-slate-50 p-4';
          card.innerHTML = `
            <div class="flex items-center justify-between mb-3">
              <div class="text-sky-900 font-semibold">Rodada ${p.round_number} • Debate ${p.debate_number}</div>
            </div>
            <div class="space-y-2">
              ${['OG','OO','CG','CO'].map(label => `
                <div class="flex items-center gap-3">
                  <span class="inline-flex w-10 justify-center rounded-md bg-sky-200/70 text-sky-900 text-xs font-bold py-1">${label}</span>
                  <span class="text-slate-800 font-medium">${p.positions[label] || ''}</span>
                </div>
              `).join('')}
            </div>
          `;
          pairingsGrid.appendChild(card);
        }
      } catch (e) {
        showAlert('Exibindo página, mas não foi possível carregar os pareamentos.');
      }
    }

    loadStandings();
    loadPairings();
  </script>
</body>
</html>
